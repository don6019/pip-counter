<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>checkVersion Tests</title>
  <link rel="stylesheet" href="https://code.jquery.com/qunit/qunit-2.20.0.css">
</head>
<body>
  <div id="qunit"></div>
  <div id="qunit-fixture">
    <h1>PIP Counter â€” V1.1</h1>
  </div>
  <script src="https://code.jquery.com/qunit/qunit-2.20.0.js"></script>
  <script>
    const currentVersion = document.querySelector('h1').textContent.split('V')[1].trim();
    const repo = 'don6019/pip-counter'; 

    async function checkVersion() {
      if (!navigator.onLine) {
          console.log("Offline, skipping version check.");
          return;
      }
      try {
        const response = await fetch(`https://api.github.com/repos/${repo}/releases/latest`);
        if (!response.ok) {
          if (response.status === 404) {
               console.warn(`Version check failed: No releases found for repo '${repo}' or repo is private. Please create a public release on GitHub.`);
          } else {
               console.error('Could not check for new version.', response.statusText);
          }
          return;
        }
        const latestRelease = await response.json();
        const latestVersion = latestRelease.tag_name.replace(/^v/i, '');

        if (parseFloat(latestVersion) > parseFloat(currentVersion)) {
          const message = `A new version (${latestVersion}) is available. You are using ${currentVersion}.`;
          const banner = document.createElement('div');
          banner.id = 'update-banner';
          banner.innerHTML = `
            <style>
              #update-banner {
                padding: 12px;
                background-color: #fffbe6;
                border-bottom: 1px solid #ffe58f;
                text-align: center;
                font-size: 14px;
                position: relative;
              }
              #update-banner a {
                font-weight: bold;
                color: var(--accent);
              }
              #update-banner .close-btn {
                background: none;
                border: none;
                font-size: 16px;
                cursor: pointer;
                position: absolute;
                top: 50%;
                right: 15px;
                transform: translateY(-50%);
                color: #888;
              }
            </style>
            <span>${message} <a href="${latestRelease.html_url}" target="_blank" rel="noopener noreferrer">View on GitHub</a></span>
            <button class="close-btn" onclick="this.parentElement.style.display='none'">&times;</button>
          `;
          document.body.insertBefore(banner, document.body.firstChild);
        }
      } catch (error) {
        console.error('Error checking for new version:', error);
      }
    }

    QUnit.module('checkVersion', function(hooks) {
      let originalFetch;
      let originalNavigatorOnLine;

      hooks.beforeEach(function() {
        originalFetch = window.fetch;
        originalNavigatorOnLine = Object.getOwnPropertyDescriptor(navigator, 'onLine');
        if (!originalNavigatorOnLine) {
          originalNavigatorOnLine = { value: navigator.onLine, writable: false, enumerable: true, configurable: true };
        }
        const banner = document.getElementById('update-banner');
        if (banner) {
          banner.remove();
        }
      });

      hooks.afterEach(function() {
        window.fetch = originalFetch;
        Object.defineProperty(navigator, 'onLine', originalNavigatorOnLine);
      });

      QUnit.test('should display update banner when a new version is available', async function(assert) {
        assert.expect(1);

        window.fetch = async (url) => {
          return {
            ok: true,
            json: async () => ({
              tag_name: 'v1.2',
              html_url: 'https://github.com/don6019/pip-counter/releases/tag/v1.2'
            })
          };
        };

        await checkVersion();

        const banner = document.getElementById('update-banner');
        assert.ok(banner, 'Update banner should be displayed');
      });

      QUnit.test('should not display update banner when the current version is the latest', async function(assert) {
        assert.expect(1);

        window.fetch = async (url) => {
          return {
            ok: true,
            json: async () => ({
              tag_name: 'v1.1',
              html_url: 'https://github.com/don6019/pip-counter/releases/tag/v1.1'
            })
          };
        };

        await checkVersion();

        const banner = document.getElementById('update-banner');
        assert.notOk(banner, 'Update banner should not be displayed');
      });

      QUnit.test('should log an error when the API call fails', async function(assert) {
        assert.expect(1);
        const originalError = console.error;
        let errorMessage = '';
        console.error = (...args) => {
          errorMessage = args.join(' ');
        };

        window.fetch = async (url) => {
          return {
            ok: false,
            status: 500,
            statusText: 'Internal Server Error'
          };
        };

        await checkVersion();

        assert.ok(errorMessage.includes('Could not check for new version.'), 'Error message should be logged');
        console.error = originalError;
      });

      QUnit.test('should log a warning when the repo has no releases', async function(assert) {
        assert.expect(1);
        const originalWarn = console.warn;
        let warnMessage = '';
        console.warn = (...args) => {
          warnMessage = args.join(' ');
        };

        window.fetch = async (url) => {
          return {
            ok: false,
            status: 404,
          };
        };

        await checkVersion();

        assert.ok(warnMessage.includes('Version check failed: No releases found'), 'Warning message should be logged');
        console.warn = originalWarn;
      });


      QUnit.test('should log a message and not fetch when offline', async function(assert) {
        assert.expect(2);
        const originalLog = console.log;
        let logMessage = '';
        console.log = (...args) => {
          logMessage = args.join(' ');
        };

        Object.defineProperty(navigator, 'onLine', {
            get: () => false
        });

        let fetchCalled = false;
        window.fetch = async (url) => {
          fetchCalled = true;
          return {
            ok: true,
            json: async () => ({
              tag_name: 'v1.2',
              html_url: 'https://github.com/don6019/pip-counter/releases/tag/v1.2'
            })
          };
        };

        await checkVersion();

        assert.ok(logMessage.includes('Offline, skipping version check.'), 'Offline message should be logged');
        assert.notOk(fetchCalled, 'Fetch should not be called when offline');
        console.log = originalLog;
      });
    });
  </script>
</body>
</html>
