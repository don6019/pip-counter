
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
<title>Bird Counter — Prototype</title>
<style>
  :root{
    --bg:#f5f7fb;
    --card:#ffffff;
    --accent:#0b76ef;
    --muted:#6b7280;
    --big:42px;
    --pad:14px;
  }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:var(--bg);color:#111}
  .wrap{max-width:900px;margin:0 auto;padding:18px;}
  header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  h1{font-size:18px;margin:0}
  .card{background:var(--card);border-radius:12px;box-shadow:0 6px 18px rgba(12,16,24,0.06);padding:14px;margin-bottom:12px}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  .row{display:flex;gap:10px;align-items:center}
  select,input[type="text"],input[type="number"]{padding:10px;border-radius:8px;border:1px solid #e6e8eb;flex:1;font-size:16px}
  .bigbuttons{display:flex;gap:10px;margin-top:12px}
  .btn{flex:1;padding:14px;border-radius:12px;border:none;font-size:20px;cursor:pointer}
  .btn-plus{background:linear-gradient(180deg,var(--accent),#0560c6);color:#fff}
  .btn-minus{background:#ef4444;color:#fff}
  .counter-display{font-size:48px;font-weight:700;text-align:center;margin-top:6px}
  .meta{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .pill{background:#f1f5f9;padding:8px 10px;border-radius:999px;font-size:13px;color:#111}
  .controls{display:flex;gap:8px;margin-top:12px}
  .small{padding:8px 10px;border-radius:10px;border:1px solid #e6e8eb;background:white;cursor:pointer}
  footer{font-size:13px;color:var(--muted);margin-top:18px;text-align:center}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border-bottom:1px solid #f1f5f9;font-size:13px;text-align:left}
  @media (max-width:520px){
    .bigbuttons{flex-direction:row}
    .btn{font-size:20px;padding:12px}
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Bird Counter — Prototype</h1>
  </header>

  <div class="card" id="setupCard">
    <label>Observer name</label>
    <input id="observer" type="text" placeholder="Your name" />

    <div style="display:flex;gap:10px;margin-top:10px">
      <div style="flex:1">
        <label>Station</label>
        <select id="station">
          <option>Station A</option>
          <option>Station B</option>
          <option>Station C</option>
          <option>Station D</option>
        </select>
      </div>
      <div style="width:120px">
        <label>Species</label>
        <input id="species" type="text" value="Target species" />
      </div>
    </div>

    <div style="display:flex;gap:10px;margin-top:10px">
      <div style="flex:1">
        <label>Session start</label>
        <input id="startDt" type="datetime-local" />
      </div>
      <div style="width:120px">
        <label>Session length (min)</label>
        <input id="sessionLength" type="number" value="120" min="15" step="15" />
      </div>
      <div style="width:120px">
        <label>Segment (min)</label>
        <input id="segmentLength" type="number" value="15" min="5" step="5" />
      </div>
    </div>

    <div class="controls">
      <button class="small" id="btnNewSession">Start New Session</button>
      <button class="small" id="btnResume">Resume Saved</button>
      <button class="small" id="btnClearSaved">Clear Saved</button>
    </div>
    <div style="margin-top:8px;color:var(--muted);font-size:13px">
      Tip: set Session start to current time or the scheduled start. Session will auto-create segments.
    </div>
  </div>

  <div class="card" id="counterCard" style="display:none">
    <div class="row">
      <div style="flex:1">
        <label>Current segment</label>
        <div class="pill" id="segmentLabel">—</div>
      </div>
      <div style="width:140px">
        <label>Segment timer</label>
        <div class="pill" id="segTimer">00:00</div>
      </div>
    </div>

    <div style="margin-top:10px">
      <label>Count for: <span id="speciesLabel">Target species</span></label>
      <div class="counter-display" id="countDisplay">0</div>

      <div class="bigbuttons">
        <button class="btn btn-minus" id="btnMinus">−</button>
        <button class="btn btn-plus" id="btnPlus">＋</button>
      </div>

      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="small" id="btnRecord">Record segment (save)</button>
        <button class="small" id="btnNext">Next segment</button>
        <button class="small" id="btnReset">Reset count</button>
        <button class="small" id="btnExport">Export CSV</button>
      </div>

      <div style="margin-top:8px;color:var(--muted);font-size:13px">
        Recorded rows will be saved locally. Use Export CSV to download a file for your desktop.
      </div>

      <div id="logArea" style="margin-top:12px;max-height:220px;overflow:auto">
        <table id="logTable"><thead><tr><th>Datetime</th><th>Observer</th><th>Station</th><th>Segment</th><th>Count</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </div>

  <footer>
    Prototype — works offline in your browser. Recommended: Add to Home screen for full-screen use.
  </footer>
</div>

<script>
(function(){
  const observerEl = document.getElementById('observer');
  const stationEl = document.getElementById('station');
  const speciesEl = document.getElementById('species');
  const startDtEl = document.getElementById('startDt');
  const sessionLenEl = document.getElementById('sessionLength');
  const segmentLenEl = document.getElementById('segmentLength');

  const btnNew = document.getElementById('btnNewSession');
  const btnResume = document.getElementById('btnResume');
  const btnClearSaved = document.getElementById('btnClearSaved');

  const counterCard = document.getElementById('counterCard');
  const counterDisplay = document.getElementById('countDisplay');
  const btnPlus = document.getElementById('btnPlus');
  const btnMinus = document.getElementById('btnMinus');
  const btnRecord = document.getElementById('btnRecord');
  const btnNext = document.getElementById('btnNext');
  const btnReset = document.getElementById('btnReset');
  const btnExport = document.getElementById('btnExport');

  const speciesLabel = document.getElementById('speciesLabel');
  const segmentLabel = document.getElementById('segmentLabel');
  const segTimer = document.getElementById('segTimer');
  const logTableBody = document.querySelector('#logTable tbody');

  let currentCount = 0;
  let session = null;
  let segments = [];
  let segmentIndex = 0;
  let timerInterval = null;
  let records = [];

  // Utilities
  function formatISO(dt){ return new Date(dt).toISOString(); }
  function pad(n){ return String(n).padStart(2,'0'); }
  function formatTimeLeft(ms){
    if(ms<0) ms=0;
    const s = Math.floor(ms/1000);
    const m = Math.floor(s/60);
    const sec = s%60;
    return pad(m)+':'+pad(sec);
  }

  function buildSegments(start, sessionMinutes, segMinutes){
    const out = [];
    let cur = new Date(start);
    const end = new Date(cur.getTime() + sessionMinutes*60000);
    while(cur < end){
      const segEnd = new Date(cur.getTime() + segMinutes*60000);
      out.push({start: new Date(cur), end: segEnd});
      cur = segEnd;
    }
    return out;
  }

  function loadSaved(){
    try{
      const s = localStorage.getItem('birdcounter_saved');
      if(s) {
        const data = JSON.parse(s);
        observerEl.value = data.observer || '';
        stationEl.value = data.station || stationEl.value;
        speciesEl.value = data.species || speciesEl.value;
        startDtEl.value = data.startLocal || '';
        sessionLenEl.value = data.sessionLength || sessionLenEl.value;
        segmentLenEl.value = data.segmentLength || segmentLenEl.value;
        const rec = localStorage.getItem('birdcounter_records');
        if(rec) {
          records = JSON.parse(rec);
          renderLog();
        }
        alert('Saved session loaded (settings and recorded rows).');
      } else {
        alert('No saved session found.');
      }
    }catch(e){ console.error(e); alert('Failed to load saved data.'); }
  }

  function saveSettings(){
    const s = {
      observer: observerEl.value,
      station: stationEl.value,
      species: speciesEl.value,
      startLocal: startDtEl.value,
      sessionLength: Number(sessionLenEl.value),
      segmentLength: Number(segmentLenEl.value)
    };
    localStorage.setItem('birdcounter_saved', JSON.stringify(s));
    localStorage.setItem('birdcounter_records', JSON.stringify(records||[]));
  }

  function clearSaved(){
    if(confirm('Clear saved settings and recorded rows?')){
      localStorage.removeItem('birdcounter_saved');
      localStorage.removeItem('birdcounter_records');
      records = [];
      renderLog();
      alert('Saved data cleared.');
    }
  }

  function startSession(){
    const startVal = startDtEl.value;
    const sesLen = Number(sessionLenEl.value);
    const segLen = Number(segmentLenEl.value);
    if(!observerEl.value) {
      if(!confirm('Observer name is empty. Continue?')) return;
    }
    const startDate = startVal ? new Date(startVal) : new Date();
    segments = buildSegments(startDate, sesLen, segLen);
    segmentIndex = 0;
    session = {start: startDate, sessionLength: sesLen, segmentLength: segLen};
    currentCount = 0;
    speciesLabel.textContent = speciesEl.value || 'Target species';
    document.getElementById('setupCard').style.display='none';
    counterCard.style.display='block';
    updateSegmentUI();
    startTimer();
    saveSettings();
  }

  function updateSegmentUI(){
    if(!segments.length) return;
    const seg = segments[segmentIndex];
    segmentLabel.textContent = seg.start.toLocaleString() + ' → ' + seg.end.toLocaleTimeString();
    counterDisplay.textContent = currentCount;
    renderLog();
  }

  function startTimer(){
    stopTimer();
    timerInterval = setInterval(()=>{
      const now = new Date();
      const seg = segments[segmentIndex];
      const msLeft = seg.end - now;
      segTimer.textContent = formatTimeLeft(msLeft);
      if(msLeft <= 0){
        // auto record and advance
        autoRecordAndAdvance();
      }
    }, 400);
  }

  function stopTimer(){
    if(timerInterval) { clearInterval(timerInterval); timerInterval = null; }
  }

  function autoRecordAndAdvance(){
    // record if not already recorded for this segment (we tag by segment start)
    const seg = segments[segmentIndex];
    const segKey = seg.start.toISOString();
    const already = records.find(r=>r.segmentStart===segKey && r.station===stationEl.value);
    if(!already){
      saveRecord(seg);
    }
    // advance to next if any
    if(segmentIndex < segments.length-1){
      segmentIndex++;
      currentCount = 0;
      updateSegmentUI();
    } else {
      // session finished
      stopTimer();
      alert('Session finished — all segments complete.');
      saveSettings();
    }
  }

  function saveRecord(seg){
    const row = {
      datetime: new Date().toISOString(),
      observer: observerEl.value,
      station: stationEl.value,
      species: speciesEl.value,
      segmentStart: seg.start.toISOString(),
      segmentEnd: seg.end.toISOString(),
      count: currentCount
    };
    records.push(row);
    localStorage.setItem('birdcounter_records', JSON.stringify(records));
    renderLog();
  }

  function renderLog(){
    logTableBody.innerHTML='';
    (records||[]).forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = '<td>'+new Date(r.segmentStart).toLocaleString()+'</td><td>'+escapeHtml(r.observer)+'</td><td>'+escapeHtml(r.station)+'</td><td>'+new Date(r.segmentStart).toLocaleTimeString()+'-'+new Date(r.segmentEnd).toLocaleTimeString()+'</td><td>'+r.count+'</td>';
      logTableBody.appendChild(tr);
    });
    // update count display
    counterDisplay.textContent = currentCount;
  }

  function escapeHtml(s){ return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  // Button handlers
  btnPlus.addEventListener('click', ()=>{ currentCount++; counterDisplay.textContent=currentCount; });
  btnMinus.addEventListener('click', ()=>{ if(currentCount>0) currentCount--; counterDisplay.textContent=currentCount; });

  btnRecord.addEventListener('click', ()=>{
    if(!segments.length) return alert('No session running');
    saveRecord(segments[segmentIndex]);
    // don't auto-advance unless user asks
    saveSettings();
    alert('Recorded: ' + currentCount + ' for current segment.');
  });

  btnNext.addEventListener('click', ()=>{
    if(segmentIndex < segments.length-1){
      // optionally auto-record before moving
      if(confirm('Record current count for this segment before moving?')){
        saveRecord(segments[segmentIndex]);
      }
      segmentIndex++;
      currentCount = 0;
      updateSegmentUI();
      saveSettings();
    } else {
      alert('This is the last segment.');
    }
  });

  btnReset.addEventListener('click', ()=>{
    if(confirm('Reset current count to 0?')){ currentCount=0; counterDisplay.textContent=currentCount; }
  });

  btnExport.addEventListener('click', ()=>{
    if(!(records && records.length)) return alert('No records to export.');
    const header = ['datetime','observer','station','species','segmentStart','segmentEnd','count'];
    const lines = [header.join(',')].concat(records.map(r=>[
      r.datetime,
      csvSafe(r.observer),
      csvSafe(r.station),
      csvSafe(r.species),
      r.segmentStart,
      r.segmentEnd,
      r.count
    ].join(',')));
    const blob = new Blob([lines.join('\\n')], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const fname = 'birdcounts_'+(new Date()).toISOString().slice(0,19).replace(/[:T]/g,'_')+'.csv';
    a.download = fname;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  function csvSafe(s){
    if(s==null) return '';
    s = s.toString();
    if(s.includes(',')||s.includes('"')||s.includes('\\n')) s = '"' + s.replace(/"/g,'""') + '"';
    return s;
  }

  btnNew.addEventListener('click', startSession);
  btnResume.addEventListener('click', loadSaved);
  btnClearSaved.addEventListener('click', clearSaved);

  // init: prefill start time with now rounded down to nearest 5 minutes local
  (function init(){
    const now = new Date();
    now.setSeconds(0,0);
    const mins = now.getMinutes();
    const rounded = Math.floor(mins/5)*5;
    now.setMinutes(rounded);
    const localISO = now.toISOString().slice(0,16);
    startDtEl.value = localISO;
    // load any saved records into log
    const rec = localStorage.getItem('birdcounter_records');
    if(rec) records = JSON.parse(rec);
    renderLog();
  })();

  // beforeunload - save settings
  window.addEventListener('beforeunload', ()=>{
    try{ saveSettings(); }catch(e){}
  });

})();
</script>
</body>
</html>
